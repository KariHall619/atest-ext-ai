---
name: atest-ext-ai-plugin-part
description: API测试工具AI插件开发 - 智能SQL生成与执行系统，支持本地模型和在线AI服务
status: backlog
created: 2025-09-10T10:40:48Z
---

# PRD: atest-ext-ai-plugin-part

## Executive Summary

本项目旨在为atest API测试工具开发AI内容生成插件，实现智能SQL生成功能。插件采用标准的Loader接口，通过`ai.generate`和`ai.capabilities`两个方法提供AI服务。插件专注于内容生成，SQL执行由主程序处理，符合单一职责原则。支持本地AI模型（Ollama）和在线AI服务，为用户提供灵活的AI服务选择。

## Problem Statement

### 核心问题  
**架构明确**：基于AI_PLUGIN_DEVELOPMENT.md文档，AI插件采用标准插件系统架构，通过`testing.Loader.Query(map[string]string)`接口提供服务。插件使用`categories: ["ai"]`标识，通过JSON消息协议进行通信。**核心实现**：专注于`ai.generate`和`ai.capabilities`两个方法的实现。

### 痛点分析
1. **SQL编写复杂度高**：复杂的JOIN查询、子查询等需要深度数据库知识
2. **多数据库语法差异**：MySQL、PostgreSQL、SQLite的语法细节差异导致用户困扰
3. **测试效率低**：手动编写SQL查询占用大量测试时间
4. **AI服务配置复杂**：需要简化AI模型配置和管理

### 业务价值
- 提升测试效率80%以上
- 降低SQL编写门槛，扩大用户群体
- 支持离线使用场景（本地模型）
- 减少因SQL语法错误导致的测试失败

## User Stories

### 主要用户画像

**1. API测试工程师（Primary）**
- 需要快速生成测试数据查询
- 希望通过自然语言描述获得SQL查询
- 关注查询准确性和执行效率

**2. QA团队Lead（Secondary）**
- 需要团队成员能快速上手复杂查询
- 关注成本控制和工具稳定性
- 希望有离线工作能力

**3. DevOps工程师（Tertiary）**
- 负责AI插件部署和配置
- 关注系统稳定性和安全性
- 需要便捷的配置管理

### 详细用户故事

#### 故事1：智能SQL生成
**作为** API测试工程师  
**我希望** 通过自然语言描述生成SQL查询  
**以便** 快速获得所需的测试数据，无需记忆复杂的SQL语法  

**验收标准：**
- [ ] 支持自然语言输入："查找所有活跃用户的订单信息"
- [ ] 自动识别数据库类型并生成对应语法的SQL
- [ ] 生成的SQL包含详细解释说明
- [ ] 支持复杂查询场景（JOIN、子查询、聚合函数等）

#### 故事2：本地AI模型配置
**作为** QA团队Lead  
**我希望** 能够便捷地配置和管理本地AI模型  
**以便** 在离线环境下使用AI功能，控制使用成本  

**验收标准：**
- [ ] 提供可视化的本地模型配置界面
- [ ] 支持主流本地模型（Ollama、LM Studio等）
- [ ] 自动检测和验证模型可用性
- [ ] 支持模型热切换，无需重启服务

#### 故事3：AI服务灵活选择
**作为** API测试工程师  
**我希望** 能够根据任务需求选择本地或在线AI服务  
**以便** 在准确性、速度和成本之间找到最佳平衡  

**验收标准：**
- [ ] 提供AI服务选择界面（本地/在线）
- [ ] 支持多个在线AI服务商（OpenAI、Claude等）
- [ ] 显示各服务的可用状态和响应时间
- [ ] 支持按项目或查询类型配置默认AI服务

#### 故事4：生成SQL的质量和准确性
**作为** API测试工程师
**我希望** AI生成的SQL质量高且准确
**以便** 减少手动修改和调试时间

**验收标准：**
- [ ] 生成的SQL语法正确
- [ ] 支持不同数据库方言（MySQL/PostgreSQL/SQLite）
- [ ] 生成的SQL包含详细注释说明
- [ ] 提供SQL复杂度和性能建议

## Requirements

### 功能需求

#### 核心AI功能
1. **AI内容生成引擎**
   - 通过`ai.generate`方法生成SQL
   - 自然语言解析和理解
   - 多数据库语法适配（MySQL/PostgreSQL/SQLite）
   - 基于schema信息的智能生成

2. **AI能力查询**
   - 通过`ai.capabilities`方法提供插件信息
   - 支持的模型列表
   - 支持的功能特性
   - 插件版本和描述信息

3. **AI服务集成**
   - 本地模型（Ollama）集成
   - 在线AI服务集成（OpenAI、Claude）
   - 配置管理和服务选择
   - 错误处理和降级策略

#### 集成功能
1. **标准Loader接口实现**
   - 实现`testing.Loader.Query(map[string]string)`接口
   - 处理`method="ai.generate"`和`method="ai.capabilities"`请求
   - 通过`categories: ["ai"]`标识AI插件
   - Unix socket通信（/tmp/atest-store-ai.sock）

2. **JSON消息协议**
   - 请求参数通过map[string]string传递
   - 复杂配置以JSON字符串形式传递
   - 响应通过DataResult.Pairs返回
   - 统一的错误处理格式

### 非功能需求

#### 性能要求
- **响应时间**：
  - HTTP API响应：< 100ms（不含AI处理）
  - AI处理总时间：< 30s
  - 本地模型响应：< 10s（优先）
  - 在线服务响应：< 15s
- **并发处理**：支持最多10个并发AI请求
- **内存占用**：插件内存增量 < 系统总内存的5%

#### 可靠性要求
- **可用性**：99.5%正常运行时间
- **错误率**：< 1% SQL生成错误率
- **故障恢复**：AI服务故障时自动降级到备用服务
- **数据完整性**：所有AI交互记录完整可追溯

#### 安全要求
- **输入验证**：防止SQL注入和提示注入攻击
- **权限控制**：基于用户角色的功能访问控制
- **数据加密**：API密钥和敏感配置加密存储
- **审计日志**：完整的AI使用审计跟踪

#### 兼容性要求
- **平台支持**：Linux、macOS、Windows
- **数据库版本**：
  - MySQL 5.7+, 8.0+
  - PostgreSQL 12+, 13+, 14+, 15+
  - SQLite 3.35+
- **Go版本**：Go 1.19+（与主项目保持一致）

## Success Criteria

### 主要成功指标

#### 用户体验指标
1. **SQL生成准确率**：≥ 85%的生成SQL能够成功执行并返回期望结果
2. **用户采用率**：60%以上的活跃用户使用AI功能
3. **任务完成效率**：相比手动编写SQL，效率提升 ≥ 80%
4. **用户满意度**：用户反馈评分 ≥ 4.0/5.0

#### 技术性能指标
1. **响应时间达标率**：95%的请求在目标时间内完成
2. **系统稳定性**：99.5%可用性，MTTR < 5分钟
3. **资源利用率**：内存使用增量 < 5%，CPU峰值 < 20%
4. **错误率控制**：整体错误率 < 1%

#### 业务价值指标
1. **成本效益**：本地模型使用率 ≥ 70%（降低API调用成本）
2. **用户留存**：AI功能用户的周活跃率 ≥ 80%
3. **功能覆盖率**：支持90%以上的常见SQL查询场景
4. **集成成功率**：插件在不同环境下的部署成功率 ≥ 95%

### 关键里程碑

#### Phase 1: 核心接口实现 (2周)
- [ ] 实现标准Loader接口
- [ ] 完成ai.generate和ai.capabilities方法
- [ ] 本地模型（Ollama）集成
- [ ] 基础测试和验证

#### Phase 2: 功能完善 (2周)
- [ ] 三种数据库语法支持
- [ ] 在线AI服务集成
- [ ] 配置管理优化
- [ ] 错误处理完善

#### Phase 3: 生产就绪 (1周)
- [ ] 集成测试覆盖
- [ ] 性能优化
- [ ] 文档完善
- [ ] 部署验证

## Constraints & Assumptions

### 技术约束
1. **架构约束**：必须严格遵循现有的双协议架构规范
2. **协议兼容性**：必须使用指定的protobuf字段号（10+）以保持向后兼容
3. **插件规范**：二进制名称必须为`atest-store-ai`，Unix socket路径固定
4. **Go版本限制**：使用Go 1.19+以保证gRPC和protobuf兼容性

### 资源约束
1. **开发时间**：5周内完成所有开发和测试
2. **团队规模**：1名Go开发工程师
3. **硬件要求**：开发环境需要支持本地AI模型运行
4. **预算限制**：在线AI服务调用控制在合理范围内

### 业务假设
1. **用户接受度**：用户愿意学习和使用AI辅助功能
2. **数据可用性**：测试环境中有足够的数据库schema信息供AI参考
3. **网络环境**：在线AI服务调用网络环境稳定
4. **模型性能**：本地AI模型能够满足基本的SQL生成需求

### 外部依赖假设
1. **主项目稳定性**：主项目的插件架构接口保持稳定
2. **AI服务可用性**：选择的AI服务商保持稳定的API服务
3. **数据库驱动**：Go数据库驱动库持续维护和更新
4. **开源模型**：本地AI模型（如Ollama支持的模型）持续可用

## Out of Scope

### 明确不包含的功能

#### V1.0版本不包含
1. **SQL执行功能**：插件不执行SQL，由主程序处理
2. **数据库连接管理**：插件不管理数据库连接
3. **复杂数据分析**：不包含商业智能分析、数据挖掘等高级分析功能
4. **AI模型训练**：不包含自定义模型训练和微调功能
5. **自动降级机制**：暂不实现本地/在线模型自动切换

#### 非核心集成
1. **其他插件集成**：不考虑与其他第三方插件的深度集成
2. **移动端支持**：不包含移动应用或响应式移动界面
3. **实时协作**：不包含多用户实时协作编辑功能
4. **版本控制**：不包含SQL查询的版本控制和分支管理

#### 高级功能
1. **性能调优建议**：不包含数据库性能优化建议
2. **数据迁移**：不包含跨数据库的数据迁移功能  
3. **备份恢复**：不包含数据备份和恢复功能
4. **监控告警**：不包含数据库监控和告警功能

### 未来版本考虑
- 多语言自然语言支持
- 高级数据分析功能
- 自定义AI模型训练接口
- 图形化查询构建器
- 移动端支持

## Dependencies

### 内部依赖

#### 主项目依赖
1. **Core Infrastructure**
   - 双协议架构必须稳定运行
   - HTTP API层和gRPC通信层正常工作
   - 前端插件系统可用
   - Unix socket通信机制正常

2. **API契约依赖**
   - `pkg/server/server.proto`接口规范
   - `pkg/testing/remote/loader.proto`通信协议
   - 前端Vue.js组件集成接口
   - 配置管理系统（stores.yaml）

3. **测试框架依赖**
   - 主项目的测试基础设施
   - Mock服务和测试数据
   - 集成测试环境
   - 性能测试工具

### 外部依赖

#### AI服务依赖
1. **本地AI模型**
   - Ollama运行环境
   - 兼容的开源模型（CodeLlama、Mistral等）
   - 足够的硬件资源（GPU可选，内存必需）

2. **在线AI服务**
   - OpenAI API（GPT-4/3.5-turbo）
   - Anthropic Claude API
   - 稳定的互联网连接
   - API密钥和额度管理

#### 技术栈依赖
1. **Go生态系统**
   - gRPC Go库（google.golang.org/grpc）
   - Protocol Buffers（google.golang.org/protobuf）
   - 数据库驱动（mysql, postgresql, sqlite）
   - HTTP路由和中间件库

2. **AI集成库**
   - OpenAI Go客户端库
   - Anthropic API客户端
   - 本地模型HTTP客户端
   - JSON和配置解析库

#### 基础设施依赖
1. **运行环境**
   - Unix-like操作系统（Linux/macOS优先）
   - Go 1.19+运行时
   - 足够的磁盘空间（本地模型存储）
   - 网络访问权限（在线服务）

2. **数据库环境**
   - MySQL/PostgreSQL/SQLite数据库实例
   - 适当的数据库权限配置
   - 测试数据和schema
   - 连接池和超时配置

### 风险评估

#### 高风险依赖
1. **在线AI服务稳定性**：服务中断将影响在线功能
2. **本地模型兼容性**：模型更新可能导致兼容性问题
3. **主项目API变更**：接口变更需要及时适配

#### 中等风险依赖
1. **数据库驱动更新**：可能影响连接稳定性
2. **gRPC库版本**：版本不兼容可能导致通信问题

#### 低风险依赖
1. **配置格式变更**：影响范围可控
2. **日志库更新**：对核心功能影响较小

### 依赖管理策略
1. **版本锁定**：关键依赖使用精确版本号
2. **定期更新**：建立依赖更新审查机制
3. **降级方案**：为关键依赖准备备选方案
4. **监控告警**：监控依赖服务的健康状态

---

*本PRD基于atest API测试工具现有架构文档和AI插件集成规范制定，确保与主项目完美集成。*